---
title: "AMP-AD Manuscript Analyses"
output: html_notebook
---

Create the qq plot.
```{r}

AMPAD::qqplotFigure()

```

Pull targeted genesets

```{r,include =F}
targetedGeneSets <- AMPAD::collateEnrichmentSets()
#str(targetedGeneSets)
```

For each of the three build the data frame of the respective Analyses

```{r,include=FALSE}
targetedEnrichment <- list()
targetedEnrichment$ad <- AMPAD::run_amp_ad_enrichment(targetedGeneSets$ad,
                                                      'AD',
                                                      hgnc = TRUE,
                                                      manifestId = 'syn11932957')

targetedEnrichment$cell <- AMPAD::run_amp_ad_enrichment(targetedGeneSets$cell,
                                                        'Cell',
                                                        hgnc= TRUE,
                                                        manifestId = 'syn11932957')

targetedEnrichment$deg <- AMPAD::run_amp_ad_enrichment(targetedGeneSets$deg,
                                                       'DEG',
                                                       hgnc=FALSE,
                                                       manifestId = 'syn11932957')

targetedEnrichment$degMeta <- AMPAD::run_amp_ad_enrichment(targetedGeneSets$degMeta,
                                                           'DEGmeta',
                                                           hgnc=FALSE,
                                                           manifestId = 'syn11932957')

targetedEnrichment$targetPathways <- AMPAD::run_amp_ad_enrichment(targetedGeneSets$targetedPathways,
                                                           'TargetedPathways',
                                                           hgnc=FALSE,
                                                           manifestId = 'syn11932957')

```


Add adjusted p-values 

```{r}
targetedEnrichment$ad$adj.pval <- p.adjust(targetedEnrichment$ad$fisherPval,method='fdr')
targetedEnrichment$deg$adj.pval <- p.adjust(targetedEnrichment$deg$fisherPval,method='fdr')
targetedEnrichment$cell$adj.pval <- p.adjust(targetedEnrichment$cell$fisherPval,method='fdr')
targetedEnrichment$degMeta$adj.pval <- p.adjust(targetedEnrichment$degMeta$fisherPval,method='fdr')
targetedEnrichment$targetPathways$adj.pval <- p.adjust(targetedEnrichment$targetPathways$fisherPval,method='fdr')
```

Make cell type summary plots

x- axis : module
y- axis fisher-'s odds ratio

```{r}
modMeta <- AMPAD::getModuleMetainfo('syn11932957')
dummyDf <- dplyr::filter(targetedEnrichment$cell,adj.pval<=0.05)
dummyDf <- dplyr::left_join(dummyDf,modMeta)
dummyDf$ModuleBrainRegion <- factor(dummyDf$ModuleBrainRegion,levels = unique(dummyDf$ModuleBrainRegion))

g <- ggplot2::ggplot(dummyDf,
                     ggplot2::aes(x = Module,
                                  y = category,
                                  size = fisherOR,
                                  color = -log10(adj.pval)))
g <- g + ggplot2::geom_count()
#g <- g + ggplot2::scale_y_log10()
g <- g + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
g <- g + ggplot2::scale_color_gradientn(colours = c(viridis::viridis(2)[2], viridis::viridis(2)[1]),values = c(0,1))
g <- g + ggplot2::coord_flip()

g

```

AD genetics summary


```{r}
dummyDf <- dplyr::filter(targetedEnrichment$ad,adj.pval<=0.05)
dummyDf <- dplyr::left_join(dummyDf,modMeta)
dummyDf$ModuleBrainRegion <- factor(dummyDf$ModuleBrainRegion,levels = unique(dummyDf$ModuleBrainRegion))

g <- ggplot2::ggplot(dummyDf,
                     ggplot2::aes(x = Module,
                                  y = category,
                                  size = fisherOR,
                                  color = -log10(adj.pval)))
g <- g+ggplot2::geom_count()
#g <- g + ggplot2::scale_y_log10()
g <- g + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
g <- g + ggplot2::coord_flip()

g


```

```{r}
#modMeta <- AMPAD::getModuleMetainfo('syn11932957')
dummyDf <- dplyr::filter(targetedEnrichment$targetPathways,adj.pval<=0.05)
dummyDf <- dplyr::left_join(dummyDf,modMeta)
dummyDf$ModuleBrainRegion <- factor(dummyDf$ModuleBrainRegion,levels = unique(dummyDf$ModuleBrainRegion))

g <- ggplot2::ggplot(dummyDf,
                     ggplot2::aes(x = Module,
                                  y = category,
                                  size = fisherOR,
                                  color = -log10(adj.pval)))
g <- g + ggplot2::geom_count()
#g <- g + ggplot2::scale_y_log10()
g <- g + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
g <- g + ggplot2::scale_color_gradientn(colours = c(viridis::viridis(2)[2], viridis::viridis(2)[1]),values = c(0,1))
g <- g + ggplot2::coord_flip()

g

```



Reformate DEG results for visualization

```{r}
tcx_keep <- intersect(grep('TCX',targetedEnrichment$deg$ModuleNameFull),
                      grep('TCX',targetedEnrichment$deg$category))
phg_keep <- intersect(grep('PHG',targetedEnrichment$deg$ModuleNameFull),
                      grep('PHG',targetedEnrichment$deg$category))
cbe_keep <- intersect(grep('CBE',targetedEnrichment$deg$ModuleNameFull),
                      grep('CBE',targetedEnrichment$deg$category))
dlpfc_keep <- intersect(grep('DLPFC',targetedEnrichment$deg$ModuleNameFull),
                      grep('DLPFC',targetedEnrichment$deg$category))
stg_keep <- intersect(grep('STG',targetedEnrichment$deg$ModuleNameFull),
                      grep('STG',targetedEnrichment$deg$category))
ifg_keep <- intersect(grep('IFG',targetedEnrichment$deg$ModuleNameFull),
                      grep('IFG',targetedEnrichment$deg$category))
fp_keep <- intersect(grep('FP',targetedEnrichment$deg$ModuleNameFull),
                      grep('FP',targetedEnrichment$deg$category))
deg <- targetedEnrichment$deg[c(tcx_keep,phg_keep,cbe_keep,dlpfc_keep,stg_keep,ifg_keep,fp_keep),]
deg$adj.pval <- p.adjust(deg$fisherPval,method='fdr')
deg <- dplyr::filter(deg,adj.pval<=0.05)
dumfun <- function(x){
  y<-grep('UP',x)
  y2 <- grep('DOWN',x)
  z <- x
  z[y] <- 'Up'
  z[y2] <- 'Down'
  return(z)
}
sexfun <- function(x){
  y<-grep('\\.FEMALE',x)
  y2 <- grep('\\.MALE',x)
  z <- rep('All',length(x))
  z[y] <- 'Female'
  z[y2] <- 'Male'
  return(z)
}
deg <- dplyr::mutate(deg,direction = dumfun(category))
deg <- dplyr::mutate(deg,sex = sexfun(category))
deg <- dplyr::mutate(deg,dirbysex = paste0(direction,'.',sex))
deg <- dplyr::left_join(deg,modMeta)
```
Plot DEG results

```{r}
g <- ggplot2::ggplot(deg,ggplot2::aes(x = Module,
                                      y = fisherOR,
                                      fill = direction))
g <- g + ggplot2::geom_col(position = 'dodge')
g <- g + ggplot2::facet_grid(. ~ sex)
g <- g + ggplot2::scale_y_log10()
g <- g + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
g <- g + ggplot2::coord_flip()

g

```


```{r}
degMeta <- targetedEnrichment$degMeta
degMeta$adj.pval <- p.adjust(degMeta$fisherPval,method='fdr')
degMeta <- dplyr::filter(degMeta,adj.pval<=0.05)
dumfun <- function(x){
  y<-grep('UP',x)
  y2 <- grep('DOWN',x)
  z <- x
  z[y] <- 'Up'
  z[y2] <- 'Down'
  return(z)
}
sexfun <- function(x){
  y<-grep('\\.FEMALE',x)
  y2 <- grep('\\.MALE',x)
  z <- rep('All',length(x))
  z[y] <- 'Female'
  z[y2] <- 'Male'
  return(z)
}
degMeta <- dplyr::mutate(degMeta,direction = dumfun(category))
degMeta <- dplyr::mutate(degMeta,sex = sexfun(category))
degMeta <- dplyr::mutate(degMeta,dirbysex = paste0(direction,'.',sex))
degMeta <- dplyr::left_join(degMeta,modMeta)
```
```{r}
ind <- grep('fixed',degMeta$category)
g <- ggplot2::ggplot(degMeta[ind,],ggplot2::aes(x = Module,
                                      y = fisherOR,
                                      fill = category))
g <- g + ggplot2::geom_col(position = 'dodge')
g <- g + ggplot2::facet_grid(. ~ sex)
g <- g + ggplot2::scale_y_log10()
g <- g + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1))
g <- g + ggplot2::coord_flip()

g

```


Overlap plot

```{r}
AMPAD::pairwiseMatrixOfEnrichments('syn11932737')

```
Make PC statistics

```{r}
AMPAD::makePcStatistics('March 2 2018')
```

Run pathway enrichments and push to synapse


```{r}
pathwayGeneSets <- AMPAD::collatePathways()
fullPathwayEnrichmentsList <- mapply(AMPAD::run_amp_ad_enrichment,
                                 pathwayGeneSets,
                                 names(pathwayGeneSets),
                                 MoreArgs = list(hgnc = TRUE,
                                                 manifestId = 'syn11932957'),
                                 SIMPLIFY = FALSE)
fullPathwayEnrichments <- do.call(rbind,fullPathwayEnrichmentsList)
rSynapseUtilities::makeTable(fullPathwayEnrichments,
                             "Aggregate Module Pathway Enrichments March 7 2018",
                             'syn2370594')
```


Diagnose DEG differences
```{r}
load(synapseClient::synGet('syn10496554',version = 10)@filePath)
amp.ad.de.geneSetsNew <- amp.ad.de.geneSets
load(synapseClient::synGet('syn10496554',version = 9)@filePath)
setdiff(amp.ad.de.geneSetsNew$`Diagnosis.Sex.DLPFC.AD-CONTROL.MALE.DOWN`,amp.ad.de.geneSets$`Diagnosis.Sex.DLPFC.AD-CONTROL.MALE.DOWN`)


```


look at glymphatic flow in tcx vs cbe
```{r}
foobar <- AMPAD::pullExpressionAndPhenoWinsorized()
cbe_diag <- foobar$mayoCER$logitDiagnosis
redCBEMatrix <- foobar$mayoCER[,colnames(foobar$mayoCER)%in%targetedGeneSets$targetedPathways$WP1877]
ab <- svd(scale(redCBEMatrix))
plot(as.factor(cbe_diag),ab$u[,2])
summary(lm(ab$u[,3] ~ cbe_diag))
pheatmap::pheatmap(cbind(cbe_diag,redCBEMatrix))

tcx_diag <- foobar$mayoTCX$logitDiagnosis
redTCXMatrix <- foobar$mayoTCX[,colnames(foobar$mayoTCX)%in%targetedGeneSets$targetedPathways$WP1877]
ab2 <- svd(scale(redTCXMatrix))
plot(as.factor(tcx_diag),ab2$u[,1])
summary(lm(ab2$u[,3] ~ tcx_diag))
pheatmap::pheatmap(cbind(tcx_diag,redTCXMatrix))

```

